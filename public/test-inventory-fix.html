<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Fix Verification</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; max-height: 300px; }
        table { border-collapse: collapse; width: 100%; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .category-badge { 
            background: #e5e7eb; 
            color: #374151; 
            padding: 2px 8px; 
            border-radius: 12px; 
            font-size: 12px; 
        }
    </style>
</head>
<body>
    <h1>Inventory Fix Verification Test</h1>
    
    <div class="test-section">
        <h2>üîê Step 1: Login</h2>
        <button onclick="login()">Login as Admin</button>
        <div id="login-result"></div>
    </div>

    <div class="test-section">
        <h2>üì¶ Step 2: Test Inventory Products API</h2>
        <button onclick="testInventoryAPI()">Test Products with Categories</button>
        <button onclick="testInventorySummary()">Test Inventory Summary</button>
        <div id="inventory-test-result"></div>
    </div>

    <div class="test-section">
        <h2>üìä Step 3: Verify Category Display</h2>
        <button onclick="showProductsTable()">Show Products with Categories</button>
        <div id="products-table-result"></div>
    </div>

    <script>
        let token = '';

        async function login() {
            try {
                const response = await fetch('http://localhost:5002/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin123' })
                });
                
                const data = await response.json();
                if (data.success) {
                    token = data.token;
                    document.getElementById('login-result').innerHTML = 
                        '<div class="success">‚úÖ Login successful! Token received.</div>';
                } else {
                    document.getElementById('login-result').innerHTML = 
                        '<div class="error">‚ùå Login failed: ' + data.message + '</div>';
                }
            } catch (error) {
                document.getElementById('login-result').innerHTML = 
                    '<div class="error">‚ùå Login error: ' + error.message + '</div>';
            }
        }

        async function testInventoryAPI() {
            if (!token) {
                document.getElementById('inventory-test-result').innerHTML = 
                    '<div class="error">‚ùå Please login first!</div>';
                return;
            }

            try {
                const response = await fetch('http://localhost:5002/api/products?limit=1000', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                if (data.message && data.data) {
                    const products = data.data;
                    const categoriesWithProducts = {};
                    let unknownCount = 0;
                    
                    products.forEach(product => {
                        const category = product.category_name || product.category || 'Unknown';
                        if (category === 'Unknown') unknownCount++;
                        if (!categoriesWithProducts[category]) {
                            categoriesWithProducts[category] = [];
                        }
                        categoriesWithProducts[category].push(product.name);
                    });
                    
                    const categoryCount = Object.keys(categoriesWithProducts).length;
                    
                    document.getElementById('inventory-test-result').innerHTML = 
                        `<div class="success">‚úÖ Products API Test Results:</div>
                         <div class="info">‚Ä¢ Total Products: ${products.length}</div>
                         <div class="info">‚Ä¢ Categories Found: ${categoryCount}</div>
                         <div class="info">‚Ä¢ Products with Unknown Category: ${unknownCount}</div>
                         <div class="info">‚Ä¢ Pagination: Page ${data.pagination.current_page} of ${data.pagination.total_pages}</div>
                         <pre>${JSON.stringify(Object.keys(categoriesWithProducts).sort(), null, 2)}</pre>`;
                } else {
                    document.getElementById('inventory-test-result').innerHTML = 
                        '<div class="error">‚ùå API test failed: ' + (data.message || 'No data returned') + '</div>';
                }
            } catch (error) {
                document.getElementById('inventory-test-result').innerHTML = 
                    '<div class="error">‚ùå API test error: ' + error.message + '</div>';
            }
        }

        async function testInventorySummary() {
            if (!token) {
                document.getElementById('inventory-test-result').innerHTML = 
                    '<div class="error">‚ùå Please login first!</div>';
                return;
            }

            try {
                const response = await fetch('http://localhost:5002/api/inventory/summary', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                if (data.message && data.data) {
                    const summary = data.data;
                    
                    document.getElementById('inventory-test-result').innerHTML += 
                        `<div class="success">‚úÖ Inventory Summary Test Results:</div>
                         <div class="info">‚Ä¢ Total Products: ${summary.total_products}</div>
                         <div class="info">‚Ä¢ Active Products: ${summary.active_products}</div>
                         <div class="info">‚Ä¢ Total Categories: ${summary.total_categories}</div>
                         <div class="info">‚Ä¢ Low Stock Items: ${summary.low_stock_items}</div>
                         <div class="info">‚Ä¢ Total Inventory Value: ‚Çπ${summary.total_inventory_value.toLocaleString()}</div>
                         <div class="info">‚Ä¢ Total Cost Value: ‚Çπ${summary.total_cost_value.toLocaleString()}</div>`;
                } else {
                    document.getElementById('inventory-test-result').innerHTML += 
                        '<div class="error">‚ùå Summary test failed: ' + (data.message || 'No data returned') + '</div>';
                }
            } catch (error) {
                document.getElementById('inventory-test-result').innerHTML += 
                    '<div class="error">‚ùå Summary test error: ' + error.message + '</div>';
            }
        }

        async function showProductsTable() {
            if (!token) {
                document.getElementById('products-table-result').innerHTML = 
                    '<div class="error">‚ùå Please login first!</div>';
                return;
            }

            try {
                const response = await fetch('http://localhost:5002/api/products?limit=50', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                if (data.message && data.data) {
                    const products = data.data;
                    
                    let tableHTML = '<h3>üìã Products with Categories (First 50)</h3>';
                    tableHTML += '<table>';
                    tableHTML += '<thead><tr><th>Product Name</th><th>Category</th><th>Price</th><th>Stock</th><th>Status</th></tr></thead>';
                    tableHTML += '<tbody>';
                    
                    products.forEach(product => {
                        const category = product.category_name || product.category || 'Unknown';
                        const categoryClass = category === 'Unknown' ? 'error' : 'success';
                        
                        tableHTML += `<tr>
                            <td>${product.name}</td>
                            <td><span class="category-badge ${categoryClass}">${category}</span></td>
                            <td>‚Çπ${product.price}</td>
                            <td>${product.stock_quantity}</td>
                            <td>${product.status}</td>
                        </tr>`;
                    });
                    
                    tableHTML += '</tbody></table>';
                    
                    document.getElementById('products-table-result').innerHTML = tableHTML;
                } else {
                    document.getElementById('products-table-result').innerHTML = 
                        '<div class="error">‚ùå Products table test failed: ' + (data.message || 'No data returned') + '</div>';
                }
            } catch (error) {
                document.getElementById('products-table-result').innerHTML = 
                    '<div class="error">‚ùå Products table error: ' + error.message + '</div>';
            }
        }
    </script>
</body>
</html>
